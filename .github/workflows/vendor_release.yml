name: Generate vendored content for the release

on:
  release:
    types: [published]

jobs:
  generate-and-publish-vendored-code:
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Generate and publish cargo vendored tarball
        run: |
          tag=$(echo $GITHUB_REF | sed 's|refs/tags/||')
          tarball_name="guest-components-${tag}-vendor.tar.gz"
          mkdir -p .cargo
          cargo vendor --locked >> .cargo/config.toml

          tar -cvzf ${tarball_name} vendor .cargo/config.toml 
          gh release upload ${tag} ${tarball_name}
        env:
          GH_TOKEN: ${{ github.token }}
