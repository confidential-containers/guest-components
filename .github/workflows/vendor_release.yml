name: Generate vendored content for the release

on:
  release:
    types: [published]

jobs:
  generate-and-publish-vendored-code:
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Generate and publish cargo vendored tarball
        run: |
          tag=$(echo $GITHUB_REF | sed 's|refs/tags/||')
          tarball_name="guest-components-${tag}-vendor.tar.gz"
          mkdir -p .cargo
          cargo vendor --locked >> .cargo/config.toml

          tar -cvzf ${tarball_name} vendor .cargo/config.toml 
          gh release upload ${tag} ${tarball_name}
        env:
          GH_TOKEN: ${{ github.token }}
