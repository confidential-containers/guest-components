name: Generate vendored content for the release

on:
  release:
    types: [published]

jobs:
  generate-and-publish-vendored-code:
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Generate and publish cargo vendored tarball
        run: |
          tag=$(echo $GITHUB_REF | sed 's|refs/tags/||')
          tarball_name="guest-components-${tag}-vendor.tar.gz"
          mkdir -p .cargo
          cargo vendor --locked >> .cargo/config.toml

          tar -cvzf ${tarball_name} vendor .cargo/config.toml 
          gh release upload ${tag} ${tarball_name}
        env:
          GH_TOKEN: ${{ github.token }}
