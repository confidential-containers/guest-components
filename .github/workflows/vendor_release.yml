name: Generate vendored content for the release

on:
  release:
    types: [published]

jobs:
  generate-and-publish-vendored-code:
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Generate and publish cargo vendored tarball
        run: |
          tag=$(echo $GITHUB_REF | sed 's|refs/tags/||')
          tarball_name="guest-components-${tag}-vendor.tar.gz"
          mkdir -p .cargo
          cargo vendor --locked >> .cargo/config.toml

          tar -cvzf ${tarball_name} vendor .cargo/config.toml 
          gh release upload ${tag} ${tarball_name}
        env:
          GH_TOKEN: ${{ github.token }}
